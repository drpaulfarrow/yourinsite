<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Page Analytics Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        canvas {
            margin: 20px auto;
            max-width: 100%;
            height: 230px;
        }
        .stat-box {
            text-align: center;
            width: 150px;
            padding: 20px;
            background-color: #eaeaea;
            border-radius: 8px;
        }
        footer {
            text-align: center;
            padding: 10px;
            background-color: #333;
            color: white;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <header>
        <h1>Page Analytics Dashboard</h1>
    </header>

    <div class="container">
        <h2>Analytics for: <span id="page-url"></span> on <span id="date"></span></h2>

        <div style="height: 230px">
            <canvas id="trend-chart"></canvas>
        </div>

        <div id="error-message" style="color: red; text-align: center; display: none;">
            <p>Failed to load data. Please try again later.</p>
        </div>
    </div>

    <footer>
        <p>Powered by YourInSite</p>
    </footer>

    <script>
        'use strict';

        document.addEventListener("DOMContentLoaded", function() {
            const page = 'https://yourin.site/';
            const currentDate = new Date().toISOString().split('T')[0];

            document.getElementById('page-url').innerText = page;
            document.getElementById('date').innerText = currentDate;

            fetch(`https://yourinsiteserverside-gdd3afe5awgscnak.westeurope-01.azurewebsites.net/api/aggregated-data?page=${encodeURIComponent(page)}&date=${currentDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        // Assuming API returns aggregatedHourlyData with hourly breakdown of metrics
                        let tooltipTitles = [];
                        let pageLoads = [];
                        let distinctUsers = [];

                        data.aggregatedHourlyData.forEach(hourData => {
                            tooltipTitles.push(`${hourData.hour}:00`);
                            pageLoads.push(hourData.page_loads);
                            distinctUsers.push(hourData.distinct_users);
                        });

                        const ctx = document.getElementById('trend-chart').getContext('2d');
                        const gradient1 = ctx.createLinearGradient(0, 0, 0, 300);
                        gradient1.addColorStop(0, 'rgba(255, 99, 132, 0.35)');
                        gradient1.addColorStop(1, 'rgba(255, 99, 132, 0.01)');

                        const gradient2 = ctx.createLinearGradient(0, 0, 0, 300);
                        gradient2.addColorStop(0, 'rgba(54, 162, 235, 0.35)');
                        gradient2.addColorStop(1, 'rgba(54, 162, 235, 0.01)');

                        let trendChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: tooltipTitles,
                                datasets: [{
                                    label: 'Visitors',
                                    data: distinctUsers,
                                    fill: true,
                                    backgroundColor: gradient1,
                                    borderColor: 'rgb(255, 99, 132)',
                                    pointBorderColor: 'rgb(255, 99, 132)',
                                    pointBackgroundColor: 'rgb(255, 99, 132)',
                                }, {
                                    label: 'Pageviews',
                                    data: pageLoads,
                                    fill: true,
                                    backgroundColor: gradient2,
                                    borderColor: 'rgb(54, 162, 235)',
                                    pointBorderColor: 'rgb(54, 162, 235)',
                                    pointBackgroundColor: 'rgb(54, 162, 235)',
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false
                                },
                                plugins: {
                                    legend: {
                                        display: true
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true
                                    },
                                    y: {
                                        display: true,
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('error-message').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching aggregated data:', error);
                    document.getElementById('error-message').style.display = 'block';
                });
        });
    </script>

</body>
</html>
